#!/bin/bash
set -o errexit -o nounset

# This script assumes that $feature and $plugin_so do not contain any special
# characters.
feature=$1
plugin_so=$2
emacs=${3:-emacs}

cat << EOF
;; Wrapper for the ecaml module  -*- lexical-binding: t; -*-
;; This file is generated by dump-ecaml.sh
(require 'cl-lib)
EOF
# Set ECAML_DUMPING so that whenever Ecaml evals a form to define
# something, it also writes that form to stdout.
ECAML_DUMPING=true "$emacs" -q --no-site-file --batch -l site-start
cat << EOF
(defconst ecaml-dumped t
  "If non-nil, Ecaml definitions were loaded from a pregenerated dump.")
(load (concat (file-name-directory load-file-name) "$plugin_so") nil t)
(provide '$feature)
EOF
